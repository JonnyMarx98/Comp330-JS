<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>JonnyIsGud</title>
    <script src="bullet.js"></script>
    <script src="enemy.js"></script>
    <script src="player.js"></script>
</head>
<canvas id="gameCanvas" width= "900" height="600"></canvas>

</html>

<script>

    var canvas;
    var context;
    var gravity = 5;
    var upgradeTimer = 6;
    var upgradeActive = false;
    var upgradeKillAmount = 50;
    var mouseY;
    var mouseX;
    var mouseIsDown = false;

    const TOPBAR_HEIGHT = 100;

    // Enemy vars
    const ENEMY_WIDTH = 50;
    const ENEMY_HEIGHT = 50;
    const ENEMY_DELAY = 200;
    var enemyX = 600;
    var enemyY = 500;
    var maxEnemySpeed = 3;
    var enemies = [];
    var newEnemy = new enemy();
    var enemyDelayTimer = ENEMY_DELAY;
    var maxEnemies = 5;
    //var spawnDelay = 60;

    // Player vars
    const PLAYER_WIDTH = 50;
    const PLAYER_HEIGHT = 50;
    var playerX = 300;
    var playerY = 300;
    var playerLives = 3;
    var PlayerSpeed = 5
    var newPlayer = new player();
    var players = [];

    // Bullet vars
    const BULLET_WIDTH = 20;
    const BULLET_HEIGHT = 20;
    var BULLET_DELAY = 10;
    var BULLET_SPEED = 20;
    var i;
    var bulletX = 5000;
    var bulletY = 5000;
    var bulletDelayTimer = BULLET_DELAY;
    var bullets = [];
    var NUMBER_OF_BULLETS = 1;
    var newBullet = new bullet;
    var destroyBullet = false;
    //var bulletDirection = 0;

    // Keys
    var keyW = false;
    var keyA = false;
    var keyS = false;
    var keyD = false;
    var keySpace = false;
    var keyUp = false;
    var keyDown = false;
    var keyLeft = false;
    var keyRight = false;

    var timer = 0;
    var score = 0;
    var enemyCounter = 0;


    window.addEventListener("keydown", keyDownHandler, false);
    window.addEventListener("keyup", keyUpHandler, false);
    window.addEventListener('touchstart', function(e) {
        // Cache the client X/Y coordinates
        mouseX = e.touches[0].clientX;
        mouseY = e.touches[0].clientY;
    }, false);

    function calculateMousePos(evt) {
        var rect = canvas.getBoundingClientRect();
        var root = document.documentElement;
        var mouseX = evt.clientX - rect.left - root.scrollLeft;
        var mouseY = evt.clientY - rect.top - root.scrollTop;
        return {
            x:mouseX,
            y:mouseY
        };
    }

    function keyDownHandler(e) {
        if(e.keyCode == 68) keyD = true;
        if(e.keyCode == 83) keyS = true;
        if(e.keyCode == 65) keyA = true;
        if(e.keyCode == 87) keyW = true;
        if(e.keyCode == 32) keySpace = true;
        if(e.keyCode == 37) keyLeft = true;
        if(e.keyCode == 38) keyUp = true;
        if(e.keyCode == 39) keyRight = true;
        if(e.keyCode == 40) keyDown = true;

    }
    function keyUpHandler(e) {
        if(e.keyCode == 68) keyD = false;
        if(e.keyCode == 83) keyS = false;
        if(e.keyCode == 65) keyA = false;
        if(e.keyCode == 87) keyW = false;
        if(e.keyCode == 32) keySpace = false;
        if(e.keyCode == 37) keyLeft = false;
        if(e.keyCode == 38) keyUp = false;
        if(e.keyCode == 39) keyRight = false;
        if(e.keyCode == 40) keyDown = false;
    }

    function handleMouseClick(evt) {
        //spawnBullet();
    }

    function handleMouseDown(evt){
        spawnBullet();
    }


    function getRandomNum(min, max) {
        return Math.floor(Math.random() * (max - min + 1) ) + min;
    }

    window.onload = function() {
        canvas = document.getElementById('gameCanvas');
        context = canvas.getContext('2d');
        canvas.onmousedown = function() {mouseDown()}
        canvas.onmouseup = function() {mouseUp()}
        canvas.ontouchstart = function() {mouseDown()}
        canvas.ontouchcancel = function() {mouseUp()}
        context.width = innerWidth;
        context.height = innerHeight;

        console.debug(context.width);
        console.debug(context.height);

        spawnPlayer();

        var framesPerSecond = 60;
        setInterval(function() {
            context.clearRect(0,0,canvas.width,canvas.height);
            moveEverything();
            drawEverything();

            //console.debug(mouseX + " " + mouseY);

            if (playerLives == 0){
                location.reload();
                window.alert("GAME OVER!     Score: " + score);
                //location.reload();
            }
            //spawnBullet();
            upgradeStuff();

        }, 1000/framesPerSecond);

        canvas.addEventListener('mousemove',
            function(evt) {
                var mousePos = calculateMousePos(evt);
                mouseX = mousePos.x;
                mouseY = mousePos.y;
            });

        canvas.addEventListener('mousedown', handleMouseClick);

    }

    function mouseDown(){
        mouseIsDown = true;
    }
    function mouseUp(){
        mouseIsDown = false;
    }

    function upgradeStuff(){
        // if (score == upgradeKillAmount && !upgradeActive){
        //     window.alert("UPGRADE UNLOCKED! Press ENTER");
        //     upgradeActive = true;
        //     BULLET_DELAY = 1;
        //     BULLET_SPEED = 50;
        //     PlayerSpeed = 10;
        //     upgradeKillAmount+=100;
        // }
        // if (upgradeActive){
        //     upgradeTimer-= 1/60;
        // }
        // if (upgradeTimer < 0){
        //     BULLET_DELAY = 10;
        //     BULLET_SPEED = 20;
        //     PlayerSpeed = 5;
        //     upgradeActive = false;
        //     upgradeTimer = 6;
        // }
    }


    function Gravity(){
        playerY += gravity;
        enemyY += gravity;
    }



    function spawnPlayer(){
        newPlayer = new player();
        newPlayer.Spawn(playerX, playerY);
        players.push(newPlayer);
    }

    function resetPlayer() {
        // playerX = 0;
        // playerY = 0;
        // timer = 0;
        players[0].Reset();

    }


    function moveEverything() {
        //Gravity();

        timer += 1/60;
        bulletDelayTimer--;
        enemyDelayTimer--;

        if (enemyDelayTimer < 0 && enemies.length < maxEnemies) {
            enemyDelayTimer = ENEMY_DELAY;
            newEnemy = new enemy();
            newEnemy.Spawn(canvas.width, Math.floor((Math.random() * canvas.height) + 1));
            enemies.push(newEnemy);
        }
        // if (enemyCounter > 25 && maxEnemySpeed < 10){
        //     enemyCounter = 0;
        //     maxEnemySpeed++;
        // }


        for (i = 0; i<bullets.length; i++) {
            bullets[i].CheckCollision(enemies);
        }

        ClampEverything();

        for (i=0; i<enemies.length; i++){
            enemies[i].CheckCollision();
            enemies[i].Update();
        }

        for (i=0; i<players.length; i++){
            players[i].Update(mouseX, mouseY);
        }

        // if (keyLeft) spawnBullet();
        // if (keyUp) spawnBullet();
        // if (keyRight) spawnBullet();
        // if (keyDown) spawnBullet();

        if (keySpace){
            spawnPlayer();
        }

        if(mouseIsDown){
            spawnBullet();
        }


        for (i = 0; i<bullets.length; i++) {
            bullets[i].Update();
        }
    }

    function spawnBullet(){
        if (bulletDelayTimer < 0) {
            bulletDelayTimer = BULLET_DELAY;
            newBullet = new bullet();
            let dx = Math.cos(players[0].playerAngle);
            let dy = Math.sin(players[0].playerAngle);
            console.debug(players[0].playerAngle);
            newBullet.Spawn(players[0].playerX, players[0].playerY,dx,dy,players[0].playerAngle);
            bullets.push(newBullet);
            //newBullet.bulletDirection = direction;
            //newBullet.directionX = mouseX;
            //newBullet.directionY = mouseY;
        }
    }

    function drawEverything() {

        //context.clearRect(0,0,canvas.width,canvas.height);
        // next line blanks out the screen with grey
        colourRect(0,0,canvas.width,canvas.height,'#1d1d20');
        // top bar
        colourRect(0,0,canvas.width,TOPBAR_HEIGHT,'grey');

        // this is the player
        for (i = 0; i < players.length; i++) {

            players[i].Draw();
        }
        // draw the enemies
        for (i = 0; i < enemies.length; i++) {
            enemies[i].Draw();
        }
        // draw the bullets
        for (i = 0; i<bullets.length; i++) {
            bullets[i].Draw();
        }
        displayText("Time: " + timer.toFixed(2), 50, 75, "red");
        displayText("Score: " + score.toFixed(0), canvas.width - 200, 75, "red");
        //displayText("MaxEnemies: " + maxEnemies.toFixed(0), 300, 75, "red");
        displayText("Lives: " + playerLives.toFixed(0), canvas.width - 600, 75, "#52e633");

    }

    function colourRect(leftX,topY, width,height, drawColor) {

        context.fillStyle = drawColor;
        context.fillRect(leftX,topY, width,height);
    }

    function displayText(text, x, y, colour) {
        context.font="60px Arial";
        context.font = "30px Comic Sans MS";
        context.fillStyle = colour;
        //context.textAlign = "center";
        context.fillText(text, x, y);
    }

    function ClampEverything(){
        for (i = 0; i<players.length; i++) {
            players[i].Clamp();
        }

        for (i = 0; i<enemies.length; i++) {
            enemies[i].Clamp();
        }
    }
</script>

